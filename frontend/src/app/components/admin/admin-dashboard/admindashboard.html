<div class="dashboard-shell">
  <mat-toolbar class="topbar">
    <div class="identity">
      <label class="avatar-wrap" for="adminAvatarInput" title="Change photo">
        <img *ngIf="avatarUrl; else adminAvatarFallback" [src]="avatarUrl" alt="Admin avatar" />
        <ng-template #adminAvatarFallback>
          <mat-icon>shield</mat-icon>
        </ng-template>
      </label>
      <input
        id="adminAvatarInput"
        type="file"
        accept="image/*"
        class="hidden-input"
        (change)="onAvatarSelected($event)"
      />
      <div class="identity-text">
        <h1>Control Center</h1>
        <p>{{ userProfile.name }} • {{ userProfile.email }}</p>
      </div>
    </div>

    <span class="spacer"></span>

    <button mat-stroked-button class="toolbar-btn" color="primary" (click)="loadDashboardSummary()">
      <mat-icon>refresh</mat-icon>
      Refresh
    </button>
    <button mat-stroked-button class="toolbar-btn" (click)="goTo('/admin-profile')">
      <mat-icon>person</mat-icon>
      Profile
    </button>
    <button mat-stroked-button class="toolbar-btn" (click)="goTo('/employees')">
      <mat-icon>groups</mat-icon>
      Employees
    </button>
    <button mat-flat-button class="logout-btn" color="warn" (click)="onLogout()">Logout</button>
  </mat-toolbar>

  <main class="content">
    <div class="message-row" *ngIf="loading || error">
      <mat-progress-spinner
        *ngIf="loading"
        mode="indeterminate"
        diameter="22"
      ></mat-progress-spinner>
      <p class="error" *ngIf="error">{{ error }}</p>
    </div>

    <section class="kpi-grid">
      <mat-card class="kpi-card kpi-primary animate-rise">
        <mat-card-header>
          <mat-icon mat-card-avatar>groups</mat-icon>
          <mat-card-title>Total Employees</mat-card-title>
          <mat-card-subtitle>Active employees</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content><h2>{{ analytics.totalEmployees }}</h2></mat-card-content>
      </mat-card>

      <mat-card class="kpi-card kpi-blue animate-rise delay-1">
        <mat-card-header>
          <mat-icon mat-card-avatar>today</mat-icon>
          <mat-card-title>Present Today</mat-card-title>
          <mat-card-subtitle>{{ analytics.attendanceRate }}% attendance</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content><h2>{{ analytics.presentToday }}</h2></mat-card-content>
      </mat-card>

      <mat-card class="kpi-card kpi-amber animate-rise delay-2">
        <mat-card-header>
          <mat-icon mat-card-avatar>pending_actions</mat-icon>
          <mat-card-title>Pending Leaves</mat-card-title>
          <mat-card-subtitle>Awaiting approval</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content><h2>{{ analytics.pendingLeaves }}</h2></mat-card-content>
      </mat-card>

      <mat-card class="kpi-card kpi-green animate-rise delay-3">
        <mat-card-header>
          <mat-icon mat-card-avatar>task_alt</mat-icon>
          <mat-card-title>Approved Leaves</mat-card-title>
          <mat-card-subtitle>This month</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content><h2>{{ analytics.approvedLeaves }}</h2></mat-card-content>
      </mat-card>
    </section>

    <mat-card class="tools-card animate-fade">
      <mat-card-title>Management Tools</mat-card-title>
      <mat-divider></mat-divider>
      <div class="tools-grid">
        <mat-card class="tool-tile" *ngFor="let item of menuItems" (click)="goTo(item.page)">
          <mat-icon>{{ item.icon }}</mat-icon>
          <span>{{ item.label }}</span>
        </mat-card>
      </div>
    </mat-card>

    <mat-card class="tools-card animate-fade">
      <mat-card-title>Recent Employees</mat-card-title>
      <mat-divider></mat-divider>
      <div class="recent-list" *ngIf="analytics.recentEmployees.length; else noRecentEmployees">
        <div class="recent-item" *ngFor="let emp of analytics.recentEmployees">
          <div>
            <strong>{{ emp.firstName }} {{ emp.lastName }}</strong>
            <p>{{ emp.employeeId }} · {{ emp.email }}</p>
          </div>
          <span>{{ emp.department || 'N/A' }}</span>
        </div>
      </div>
      <ng-template #noRecentEmployees>
        <p class="empty-note">No employee records found.</p>
      </ng-template>
    </mat-card>

    <section class="bottom-grid animate-fade">
      <mat-card class="info-card">
        <mat-card-title>Quick Stats</mat-card-title>
        <mat-card-content>
          <p>Attendance Rate: {{ analytics.attendanceRate }}%</p>
          <p>Leave Approval Rate: {{ analytics.leaveApprovalRate }}%</p>
        </mat-card-content>
      </mat-card>

      <mat-card class="info-card">
        <mat-card-title>System Info</mat-card-title>
        <mat-card-content>
          <p>Admin Account: {{ userProfile.email }}</p>
          <p>Last Login: {{ userProfile.lastLogin }}</p>
          <p>Last Sync: {{ analytics.generatedAt | date: 'short' }}</p>
          <button mat-button color="warn" *ngIf="avatarUrl" (click)="removeAvatar()">Remove Photo</button>
        </mat-card-content>
      </mat-card>
    </section>
  </main>
</div>
